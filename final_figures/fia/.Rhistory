ee_path <- ee_utils_py_to_r(utils_py$ee_path())
email_clean <- gsub("@gmail.com", "", email)
ee_path_user <- sprintf("%s/%s", ee_path, email_clean)
# Is there some Google Drive Token in this Folder?
full_credentials <- list.files(path = ee_path_user, full.names = TRUE)
drive_condition <- grepl(".*_.*@.*", basename(full_credentials))
drive_credentials <- full_credentials[drive_condition]
email <- sub("^[^_]*_", "", basename(drive_credentials))
print(ee_path_user)
print(email)
ee_clean_credentials("cnorlen@uci.edu")
ee_Initialize("cnorlen")
ee_Initialize("cnorlen", drive = TRUE)
googledrive::drive_auth(email="cnorlen@uci.edu")
gargle_oauth_email = "cnorlen@uci.edu"
googledrive::drive_auth(email= gargle::gargle_oath_email(),
path = NULL,
scopes = "https://www.googleapis.com/auth/drive",
cache = gargle::gargle_oauth_cache(),
use_oob = gargle::gargle_oob_default(),
token = NULL)
library(googledrive)
googledrive::drive_auth(email= gargle::gargle_oath_email(),
path = NULL,
scopes = "https://www.googleapis.com/auth/drive",
cache = gargle::gargle_oauth_cache(),
use_oob = gargle::gargle_oob_default(),
token = NULL)
googledrive::drive_auth(email= "cnorlen@uci.edu")
ee_check_credentials()
ee_Initialize(drive = TRUE)
library(Rcpp)
install.packages('Rcpp',repo='https://cran.r-project.org/')
install.packages("Rcpp", repo = "https://cran.r-project.org/")
library(Rcpp)
install.packages('httpuv',repo='https://cran.r-project.org/')
library(httpuv)
ee_Initialize(drive = TRUE)
library(rgee)
ee_Initialize(drive = TRUE)
p <- c('dplyr','tidyr','ggplot2','ggpubr','segmented', 'patchwork','RColorBrewer','gt', 'gtsummary',
'webshot', 'kableExtra', 'broom', 'ggpmisc', 'relaimpo', 'mlr', 'caret', 'stats', 'purrr',
'nlme')
#Load packages
lapply(p,require,character.only=TRUE)
#Set working directory
setwd('C:/Users/can02/mystuff/subsequent-drought')
#Increase the memory limit for R. Helps with spatially explicit analyses.
memory.limit(32000)
#Read in csv data for Regression Data Sets
dir_in <- "D:\\Large_Files\\Landsat"
# all.ca <- read.csv(file.path(dir_in, "Regression_all_socal_300m_v23.csv"))
all.ca <- read.csv(file.path(dir_in, "Regression_all_socal_300m_v23_v3.csv"))
# summary(all.ca)
# summary(all.ca.test)
#Calculate the difference between SPI48 2002 and SPI48 2015
all.ca$dSPI48 <- abs(all.ca$spi48_09_2015 - all.ca$spi48_09_2002)
#Adding a drought sequence column to the data set
all.ca <- all.ca %>% mutate(drought.sequence = case_when((spi48_09_2002 <= -1.5) & (spi48_09_2015 <= -1.5) & (dSPI48 <= 0.5) ~ 'Both Droughts',
(spi48_09_2015 <= -1.5) & (spi48_09_2002 > spi48_09_2015) & (spi48_09_2002 > -1.5) & (dSPI48 > 0.5) ~ '2nd Drought Only',
(spi48_09_2002) <= -1.5 & (spi48_09_2002 < spi48_09_2015) & (spi48_09_2015 > -1.5) & (dSPI48 > 0.5) ~ '1st Drought Only'))
#Check if PET_4yr_2009 is postive or negative
all.ca %>% filter(drought.sequence == 'Both Droughts') %>% dplyr::select(PET_4yr_2009, PET_4yr_2002, PET_4yr_2015) %>%
summarize(PET_2002.mean = mean(PET_4yr_2002), PET_2009.mean = mean(PET_4yr_2009), PET_2015.mean = mean(PET_4yr_2015))
#Select columns of data
all.ca.1stDrought <- dplyr::select(all.ca, c(system.index, dNDMI_2004, PET_4yr_2002, ppt_4yr_2002, tmax_4yr_2002, ET_4yr_2002, biomass_1999, ADS_2004, spi48_09_2002, elevation, latitude, longitude, USFS_zone, drought.sequence))
#Add the year of the 1999-2002 data
all.ca.1stDrought$drought <- '1999-2002'
#Rename the columns
colnames(all.ca.1stDrought) <- c('pixel.id', 'dNDMI', 'PET_4yr', 'ppt_4yr', 'tmax_4yr', 'ET_4yr', 'biomass', 'ADS', 'spi48', 'elevation', 'latitude', 'longitude', 'USFS', 'sequence', 'drought')
#Select columns of the 2012-2015 data
all.ca.2ndDrought <- dplyr::select(all.ca, c(system.index, dNDMI_2017, PET_4yr_2015, ppt_4yr_2015, tmax_4yr_2015, ET_4yr_2015, biomass_2012, ADS_2017, spi48_09_2015, elevation, latitude, longitude, USFS_zone, drought.sequence))
#Add the year of the 2012-2015 data
all.ca.2ndDrought$drought <- '2012-2015'
#Rename the columns
colnames(all.ca.2ndDrought) <- c('pixel.id', 'dNDMI', 'PET_4yr', 'ppt_4yr', 'tmax_4yr', 'ET_4yr', 'biomass', 'ADS', 'spi48', 'elevation', 'latitude', 'longitude', 'USFS', 'sequence', 'drought')
#Combine all the data in one data frame
all.ca.combined <- rbind(all.ca.1stDrought, all.ca.2ndDrought)
#Translate the region code to text
all.ca.combined$region[all.ca.combined$USFS == 261] <- "Sierra Nevada"
all.ca.combined$region[all.ca.combined$USFS == 262] <- "Southern California"
#Convert the ADS data to categorical mortality or no mortality
#Trying the ADS Categorical with a 3 threshold
all.ca.combined <- all.ca.combined %>% mutate(ADS.cat = case_when(
(ADS) >= 5 ~ 1, #mortality
(ADS) < 5 ~ 0)) #no mortality
#Make drought sequence into dummy categorical variables for statistical analysis
all.ca.sample <- all.ca.combined %>% mutate(sequence.c = case_when(
sequence == 'Both Droughts' ~ 0,
sequence == '2nd Drought Only' ~ 1))
#Make years into dummy variables for statistical analysis
all.ca.sample <- all.ca.sample %>% mutate(drought.c = case_when(
drought == '1999-2002' ~ 0,
drought == '2012-2015' ~ 1))
#Create data sets as factors
all.ca.sample$sequence.f <- as.factor(all.ca.sample$sequence)
all.ca.sample$drought.f <- as.factor(all.ca.sample$drought)
#Select the drought sequence samples and data columns for analysis
dataset <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' | sequence == '2nd Drought Only') %>%
dplyr::select('PET_4yr', 'dNDMI', 'drought.c', 'sequence.c', 'biomass', 'pixel.id', 'tmax_4yr', 'ADS.cat')
#Convert the dummy variables to a numeric format
dataset$sequence.n <- as.numeric(dataset$sequence.c)
dataset$drought.n <- as.numeric(dataset$drought.c)
#Calculate sample size for 1999-2002 and proportion impacted by drought
all.ca.combined %>% dplyr::filter(drought == '1999-2002' & spi48 <= -1.5) %>% count()
all.ca.combined %>% dplyr::filter(drought == '1999-2002' & spi48 <= -1.5) %>% count() / all.ca.combined %>% dplyr::filter(drought == '1999-2002') %>% count()
all.ca.combined %>% dplyr::filter(drought == '1999-2002' & spi48 <= -1.5) %>% count()
#Calculate sample sizes for 2012-2015 and proportion impacted by drought
all.ca.combined %>% dplyr::filter(drought == '2012-2015' & spi48 <= -1.5) %>% count()
all.ca.combined %>% dplyr::filter(drought == '2012-2015' & spi48 <= -1.5) %>% count() / all.ca.combined %>% dplyr::filter(drought == '2012-2015') %>% count()
#Random number seed was not set with published results (e.g., set.seed)
#Convert dummy variables to factors
dataset$sequence.f <- as.factor(dataset$sequence.c)
dataset$drought.f <- as.factor(dataset$drought.c)
dataset.3 <- all.ca.sample %>% arrange(drought.f, pixel.id, by_group = TRUE)
#Combined anova/t-test analysis for Biomass by year collected and drought sequence
biomass.aov <- aov(data = all.ca.sample, biomass ~ drought.f*sequence.f)
#Tukey Post Hoc analysis for biomass
biomass.tHSD <- TukeyHSD(biomass.aov)
#ANOVA for Pr-ET
PET_4yr.aov <- aov(data = all.ca.sample, PET_4yr ~ drought.f*sequence.f)
#Tukey Post Hoc analysis for Pr-ET
PET_4yr.tHSD <- TukeyHSD(PET_4yr.aov)
#ANOVA for Precip
ppt_4yr.aov <- aov(data = all.ca.sample, ppt_4yr ~ drought.f*sequence.f)
#Tukey Post Hoc analysis for Pr-ET
ppt_4yr.tHSD <- TukeyHSD(ppt_4yr.aov)
#ANOVA for ET
ET_4yr.aov <- aov(data = all.ca.sample, ET_4yr ~ drought.f*sequence.f)
#Tukey Post Hoc analysis for ET
ET_4yr.tHSD <- TukeyHSD(ET_4yr.aov)
#ANOVA for Tmax
tmax_4yr.aov <- aov(data = all.ca.sample, tmax_4yr ~ drought.f*sequence.f)
#Tukey Post Hoc analysis for Tmax
tmax_4yr.tHSD <- TukeyHSD(tmax_4yr.aov)
#ANOVA for dNDMI
dNDMI.aov <- aov(data = all.ca.sample, dNDMI ~ drought.f*sequence.f)
#Tukey Post Hoc analysis for dNDMI
dNDMI.tHSD <- TukeyHSD(dNDMI.aov)
#Create a combined a list of Tukey HSD tests
tHSD <- list(biomass.tHSD, dNDMI.tHSD,
PET_4yr.tHSD, tmax_4yr.tHSD)
#Create a data frame of tukey HSD tests
df.tHSD <- as.data.frame(purrr::map_df(tHSD, tidy))
#Create labels for columns in HTML format
df.tHSD$variable <- c('Biomass (Mg ha<sup>-1</sup>)', 'Biomass (Mg ha<sup>-1</sup>)', 'Biomass (Mg ha<sup>-1</sup>)', 'Biomass (Mg ha<sup>-1</sup>)', 'Biomass (Mg ha<sup>-1</sup>)', 'Biomass (Mg ha<sup>-1</sup>)', 'Biomass (Mg ha<sup>-1</sup>)', 'Biomass (Mg ha<sup>-1</sup>)',
'dNDMI', 'dNDMI', 'dNDMI', 'dNDMI', 'dNDMI', 'dNDMI', 'dNDMI', 'dNDMI',
'Pr-ET (mm 4yr<sup>-1</sup>)', 'Pr-ET (mm 4yr<sup>-1</sup>)', 'Pr-ET (mm 4yr<sup>-1</sup>)', 'Pr-ET (mm 4yr<sup>-1</sup>)', 'Pr-ET (mm 4yr<sup>-1</sup>)', 'Pr-ET (mm 4yr<sup>-1</sup>)', 'Pr-ET (mm 4yr<sup>-1</sup>)', 'Pr-ET (mm 4yr<sup>-1</sup>)',
'Temperature (C)', 'Temperature (C)', 'Temperature (C)', 'Temperature (C)', 'Temperature (C)', 'Temperature (C)', 'Temperature (C)', 'Temperature (C)')
summary(all.ca.sample)
#Get the sample size for the two main drought sequences
all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002') %>% count()
all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002') %>% count()
#Add mean values for Estimate 1
df.tHSD$estimate.1 <- c(#Biomass density
mean((all.ca.sample %>% filter(drought == '2012-2015'))$biomass), mean((all.ca.sample %>% filter(sequence == 'Both Droughts'))$biomass),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$biomass), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$biomass),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$biomass), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$biomass),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$biomass), mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$biomass),
#dNDMI
mean((all.ca.sample %>% filter(drought == '2012-2015'))$dNDMI), mean((all.ca.sample %>% filter(sequence == 'Both Droughts'))$dNDMI),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$dNDMI), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$dNDMI),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$dNDMI), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$dNDMI),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$dNDMI), mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$dNDMI),
#PET 4yr
mean((all.ca.sample %>% filter(drought == '2012-2015'))$PET_4yr), mean((all.ca.sample %>% filter(sequence == 'Both Droughts'))$PET_4yr),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$PET_4yr), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$PET_4yr),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$PET_4yr), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$PET_4yr),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$PET_4yr), mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$PET_4yr),
#Temperature 4yr
mean((all.ca.sample %>% filter(drought == '2012-2015'))$tmax_4yr), mean((all.ca.sample %>% filter(sequence == 'Both Droughts'))$tmax_4yr),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$tmax_4yr), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$tmax_4yr),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$tmax_4yr), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$tmax_4yr),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$tmax_4yr), mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == 'Both Droughts'))$tmax_4yr))
#Add mean values for Estimate 2
df.tHSD$estimate.2 <- c(#Biomass
mean((all.ca.sample %>% filter(drought == '1999-2002'))$biomass), mean((all.ca.sample %>% filter(sequence == '2nd Drought Only'))$biomass),
mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$biomass), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$biomass),
mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$biomass), mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$biomass),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$biomass), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$biomass),
#dNDMI
mean((all.ca.sample %>% filter(drought == '1999-2002'))$dNDMI), mean((all.ca.sample %>% filter(sequence == '2nd Drought Only'))$dNDMI),
mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$dNDMI), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$dNDMI),
mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$dNDMI), mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$dNDMI),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$dNDMI), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$dNDMI),
#PrET 4yr
mean((all.ca.sample %>% filter(drought == '1999-2002'))$PET_4yr), mean((all.ca.sample %>% filter(sequence == '2nd Drought Only'))$PET_4yr),
mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$PET_4yr), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$PET_4yr),
mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$PET_4yr), mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$PET_4yr),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$PET_4yr), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$PET_4yr),
#Tmax 4yr
mean((all.ca.sample %>% filter(drought == '1999-2002'))$tmax_4yr), mean((all.ca.sample %>% filter(sequence == '2nd Drought Only'))$tmax_4yr),
mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$tmax_4yr), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$tmax_4yr),
mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == '2nd Drought Only'))$tmax_4yr), mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$tmax_4yr),
mean((all.ca.sample %>% filter(drought == '2012-2015' & sequence == '2nd Drought Only'))$tmax_4yr), mean((all.ca.sample %>% filter(drought == '1999-2002' & sequence == 'Both Droughts'))$tmax_4yr))
#Select and sort the tukey HSD columns and
df.tHSD.pub <- df.tHSD %>% dplyr::select(variable, contrast, estimate.1, estimate.2, estimate, conf.low, conf.high, adj.p.value)
#Name the columns of the data frame
colnames(df.tHSD.pub) <- c('Variable', 'Comparison', 'Estimate 1', 'Estimate 2','Difference', 'Low 95% CI', 'High 95% CI', 'p-value')
#ANOVA and Tukey HSD comparing by time period and drought sequence
tb1 <- kbl(df.tHSD.pub, format = 'html', caption = "Table S2: ANOVA and Tukey HSD Results", digits = 3, escape = F) %>% kable_classic_2(font_size = 14, full_width = F)
as_image(x = tb1, width = 10, file = "STable2_tHSD_test_results.png", zoom = 5.0)
#Create same table as Table 2, but add a percent change column, not included with manuscript
#Calculate proportion differences from Tukey HSD tests
df.tHSD$diff.pct <- df.tHSD$estimate / df.tHSD$estimate.1 * 100
df.tHSD$low.pct <- df.tHSD$conf.low / df.tHSD$estimate.1 * 100
df.tHSD$high.pct <- df.tHSD$conf.high / df.tHSD$estimate.1 * 100
#Select and sort the tukey HSD columns and
df.tHSD.sup <- df.tHSD %>% dplyr::select(variable, contrast, estimate.1, estimate.2, estimate, conf.low, conf.high, diff.pct, high.pct, low.pct, adj.p.value)
#Name the columns of the data frame
colnames(df.tHSD.sup) <- c('Variable', 'Comparison', 'Estimate 1', 'Estimate 2','Difference', 'Low 95% CI', 'High 95% CI', 'Difference (%)', 'Low (%)', 'High (%)', 'p-value')
#ANOVA and Tukey HSD comparing by time period and drought sequence, same as Table S2 plus % changes
tb3 <- kbl(df.tHSD.sup, format = 'html', caption = "Table S13: ANOVA and Tukey HSD Results with Percentages", digits = 3, escape = F) %>% kable_classic_2(font_size = 14, full_width = F)
as_image(x = tb3, width = 10, file = "STable13_tHSD_test_results_with_pct.png", zoom = 5.0)
#Filtering by drought sequence
summary(all.ca)
all.ca.both <- all.ca %>% dplyr::filter(drought.sequence == 'Both Droughts')
all.ca.2015 <- all.ca %>% dplyr::filter(drought.sequence == '2nd Drought Only')
#Paired t-tests for Geo-spatial data sets
#Biomass
biomass.both.t <- t.test(data = all.ca.both, x = all.ca.both$biomass_1999, y = all.ca.both$biomass_2012, paired = TRUE)
biomass.2015.t <- t.test(data = all.ca.2015, x = all.ca.2015$biomass_1999, y = all.ca.2015$biomass_2012, paired = TRUE)
#four-year Pr-ET
PET_4yr.both.t <- t.test(data = all.ca.both, x = all.ca.both$PET_4yr_2002, y = all.ca.both$PET_4yr_2015, paired = TRUE)
PET_4yr.2015.t <- t.test(data = all.ca.2015, x = all.ca.2015$PET_4yr_2002, y = all.ca.2015$PET_4yr_2015, paired = TRUE)
#four-year Precip
ppt_4yr.both.t <- t.test(data = all.ca.both, x = all.ca.both$ppt_4yr_2002, y = all.ca.both$ppt_4yr_2015, paired = TRUE)
ppt_4yr.2015.t <- t.test(data = all.ca.2015, x = all.ca.2015$ppt_4yr_2002, y = all.ca.2015$ppt_4yr_2015, paired = TRUE)
#four-year ET
ET_4yr.both.t <- t.test(data = all.ca.both, x = all.ca.both$ET_4yr_2002, y = all.ca.both$ET_4yr_2015, paired = TRUE)
ET_4yr.2015.t <- t.test(data = all.ca.2015, x = all.ca.2015$ET_4yr_2002, y = all.ca.2015$ET_4yr_2015, paired = TRUE)
#four-year Tmax
tmax_4yr.both.t <- t.test(data = all.ca.both, x = all.ca.both$tmax_4yr_2002, y = all.ca.both$tmax_4yr_2015, paired = TRUE)
tmax_4yr.2015.t <- t.test(data = all.ca.2015, x = all.ca.2015$tmax_4yr_2002, y = all.ca.2015$tmax_4yr_2015, paired = TRUE)
#dNDMI
dNDMI.both.t <- t.test(data = all.ca.both, x = all.ca.both$dNDMI_2004, y = all.ca.both$dNDMI_2017, paired = TRUE)
dNDMI.2015.t <- t.test(data = all.ca.2015, x = all.ca.2015$dNDMI_2004, y = all.ca.2015$dNDMI_2017, paired = TRUE)
#Combine all the t-test results in a list
t <- list(biomass.both.t, biomass.2015.t, dNDMI.both.t, dNDMI.2015.t,
PET_4yr.both.t, PET_4yr.2015.t, tmax_4yr.both.t, tmax_4yr.2015.t)
#Combine the t-test results in a data frame
df.t <- as.data.frame(purrr::map_df(t, tidy))
#Add a variable label column
df.t$variable <- c('Biomass (Mg ha<sup>-1</sup>)','Biomass (Mg ha<sup>-1</sup>)','dNDMI','dNDMI',
'Pr-ET (mm 4yr<sup>-1</sup>)','Pr-ET (mm 4yr<sup>-1</sup>)','Temperature (C)','Temperature (C)')
#Add a drought sequence column
df.t$sequence <- c('Both Droughts', '2nd Drougth Only', 'Both Droughts', '2nd Drougth Only',
'Both Droughts', '2nd Drougth Only','Both Droughts', '2nd Drougth Only')
#Add mean values for 1999-2002
df.t$value.1999 <- c(mean(all.ca.both$biomass_1999), mean(all.ca.2015$biomass_1999), mean(all.ca.both$dNDMI_2004), mean(all.ca.2015$dNDMI_2004),
mean(all.ca.both$PET_4yr_2002), mean(all.ca.2015$PET_4yr_2002), mean(all.ca.both$tmax_4yr_2002), mean(all.ca.2015$tmax_4yr_2002))
#Add mean values for 2012-2015
df.t$value.2012 <- c(mean(all.ca.both$biomass_2012), mean(all.ca.2015$biomass_2012), mean(all.ca.both$dNDMI_2017), mean(all.ca.2015$dNDMI_2017),
mean(all.ca.both$PET_4yr_2015), mean(all.ca.2015$PET_4yr_2015), mean(all.ca.both$tmax_4yr_2015), mean(all.ca.2015$tmax_4yr_2015))
#Select columns and put them in order
df.t.label <- df.t %>% dplyr::select(variable, sequence, value.1999, value.2012, estimate, conf.low, conf.high, statistic, p.value)
#Give the different columns names
colnames(df.t.label) <- c('Variable','Drought Sequence', 'Estimate 1', 'Estimate 2', 'Difference', 'Low 95% CI', 'High 95% CI', 't', 'p-value')
#Paired T-test table
tb2 <- kbl(df.t.label, format = 'html', caption = "Table S1: Paired two-tailed T-Test Results", escape = F, digits = 3) %>% kable_classic_2(font_size = 14, full_width = F)
as_image(x = tb2, width = 10, file = "STable1_paired_t_test_results.png", zoom = 5.0)
#Create table that is the same as Table 2, but has percent change column. Not included with manuscript
#Calculate percent differences for paired t-tests
df.t$diff.pct <- df.t$estimate / df.t$value.1999 * 100
df.t$low.pct <- df.t$conf.low / df.t$value.1999 * 100
df.t$high.pct <- df.t$conf.high / df.t$value.1999 * 100
#Select columns
df.t.sup <- df.t %>% dplyr::select(variable, sequence, value.1999, value.2012, estimate, conf.low, conf.high, diff.pct, low.pct, high.pct, statistic, p.value, parameter)
#Give the different columns names
colnames(df.t.sup) <- c('Variable','Drought Sequence', 'Estimate 1', 'Estimate 2', 'Difference', 'Low 95% CI', 'High 95% CI', 'Difference (%)', 'Low (%)', 'High (%)', 't', 'p-value', 'df (n-1)')
#Paired T-test table
tb4 <- kbl(df.t.sup, format = 'html', caption = "Table S8: Paired two-tailed T-Test Results with Percentages", escape = F, digits = 3) %>% kable_classic_2(font_size = 14, full_width = F)
as_image(x = tb4, width = 10, file = "STable8_t_test_results_with_pct.png", zoom = 5.0)
#Select out ADS die-off data for chi-square test
ADS.1999.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.both.alive
ADS.1999.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.both.dead
ADS.2015.both.alive <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.both.alive
ADS.2015.both.dead <- all.ca.sample %>% dplyr::filter(sequence == 'Both Droughts' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.both.dead
ADS.1999.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '1999-2002' & ADS.cat == 0) %>% count()
ADS.1999.second.alive
ADS.1999.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '1999-2002' & ADS.cat == 1) %>% count()
ADS.1999.second.dead
ADS.2015.second.alive <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '2012-2015' & ADS.cat == 0) %>% count()
ADS.2015.second.alive
ADS.2015.second.dead <- all.ca.sample %>% dplyr::filter(sequence == '2nd Drought Only' & drought == '2012-2015' & ADS.cat == 1) %>% count()
ADS.2015.second.dead
#Create a frequency matrix for a chi-square test
ADS <- matrix(c(as.numeric(ADS.1999.both.dead), as.numeric(ADS.2015.both.dead), as.numeric(ADS.1999.second.dead), as.numeric(ADS.2015.second.dead),
as.numeric(ADS.1999.both.alive), as.numeric(ADS.2015.both.alive), as.numeric(ADS.1999.second.alive), as.numeric(ADS.2015.second.alive)), ncol=2)
#Give the matrix column and row names
colnames(ADS) <- c("Mortality", "No Mortality")
rownames(ADS) <- c('Both Droughts: 1999-2002', 'Both Droughts: 2012-2015', '2nd Drought Only: 1999-2002','2nd Drought Only: 2012-2015')
#Convert the matrix to a data frame
ADS <- as.data.frame(ADS)
ADS
#Do the chi-squared test
mychi <- chisq.test(ADS)
#Print the results of the chi-square
mychi
#Print the expected result if there is no association
mychi$expected
#Calculate proportion of ADS mortality and no mortality by drought sequence and time period
#2012-2015 Only sample in 1999-2002
second.2002 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% sum()
second.2002.total <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% count()
second.2002 / second.2002.total
#2nd Drought Only sample in 2012-2015
second.2015 <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% sum()
second.2015.total <- all.ca.sample %>% filter(sequence == '2nd Drought Only' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% count()
second.2015 / second.2015.total
#Both Droughts sample in 1999-2002
both.2002 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% sum()
both.2002.total <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '1999-2002') %>% dplyr::select(ADS.cat) %>% count()
both.2002 / both.2002.total
#Both Droughts sample in 2012-2015
both.2015 <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% sum()
both.2015.total <- all.ca.sample %>% filter(sequence == 'Both Droughts' & drought == '2012-2015') %>% dplyr::select(ADS.cat) %>% count()
both.2015 / both.2015.total
p <- c("RSQLite","dbplyr","ggplot2","dplyr","tidyr", "ggpubr", "RColorBrewer",
'gt', 'gtsummary', 'webshot', 'kableExtra', 'broom', 'sf')
# If necessary: install/update packages
# install.packages('rlang',repo='https://cloud.r-project.org/')
# library("agricolae")
# Load packages
lapply(p,require,character.only=TRUE)
#Set working directory
#setwd("/C/Users/Carl/mystuff/Goulden_Lab/Forest_Dieback/dieback/figure_set/field_data")
#cd /C/Users/Carl/mystuff/Goulden_Lab/Forest_Dieback/dieback/figure_set/field_data
#cd /C/Users/can02/mystuff/fireDieoff/FIA
#Command for calling the script in the command line: R < stand_age_dieoff.r --vanilla
#INstalling packages: install.packages('RColorBrewer',repo='https://cran.cnr.berkeley.edu/')
setwd('C:/Users/can02/mystuff/fireDieoff/final_figures/fia')
#Add Data Sets
sql_dir <- 'D:\\Large_Files\\FIA\\SQLite_FIADB_CA\\2019_version' #Download from FIA DataMart
dir_usfs <- "D:\\Large_Files\\USFS\\data\\subsections"
fiaCA <- file.path(sql_dir, 'FIADB_CA.db')
sqlite.driver <- dbDriver("SQLite")
db <- dbConnect(sqlite.driver,
dbname = fiaCA)
#Creating a plot of mortality by tree species in two time periods and drought sequences.
#Create a notin operator
`%notin%` <- Negate(`%in%`)
#Add USFS EcoRegion maps
usfs_in <- "D:\\Large_Files\\USFS\\data\\subsections"
usfs.regions <- st_read(file.path(usfs_in, 'S_USA.EcomapSubsections.shp'))
#South Sierra
usfs.sierra <- subset(usfs.regions, MAP_UNIT_S == 'M261Ep' | MAP_UNIT_S =='M261Eq' | MAP_UNIT_S =='M261Eu' | MAP_UNIT_S =='M261Er'  | MAP_UNIT_S =='M261Eo'  | MAP_UNIT_S =='M261Es' |
#North Sierra
MAP_UNIT_S == 'M261Ea'  | MAP_UNIT_S =='M261Eb'  | MAP_UNIT_S =='M261Ec'  | MAP_UNIT_S =='M261Ed'  | MAP_UNIT_S =='M261Ef'  | MAP_UNIT_S =='M261Eg'  | MAP_UNIT_S =='M261Eh'  | MAP_UNIT_S =='M261Ej'  | MAP_UNIT_S =='M261Ek'  | MAP_UNIT_S =='M261El'  | MAP_UNIT_S =='M261Em'  | MAP_UNIT_S =='M261Et')
#North Sierra Union
south.sierra <- subset(usfs.regions, MAP_UNIT_S == 'M261Ep' | MAP_UNIT_S =='M261Eq' | MAP_UNIT_S =='M261Eu' | MAP_UNIT_S =='M261Er'  | MAP_UNIT_S =='M261Eo'  | MAP_UNIT_S =='M261Es') %>% st_union()
#South Sierra Union
north.sierra <- subset(usfs.regions, MAP_UNIT_S == 'M261Ea'  | MAP_UNIT_S =='M261Eb'  | MAP_UNIT_S =='M261Ec'  | MAP_UNIT_S =='M261Ed'  | MAP_UNIT_S =='M261Ef'  | MAP_UNIT_S =='M261Eg' |
MAP_UNIT_S =='M261Eh'  | MAP_UNIT_S =='M261Ej'  | MAP_UNIT_S =='M261Ek'  | MAP_UNIT_S =='M261El'  | MAP_UNIT_S =='M261Em'  | MAP_UNIT_S =='M261Et') %>% st_union()
#Add extension functions, allows more math functions
initExtension(db)
# summary(db)
#Query for FIA live trees, 2014-2019
q1 <- dbSendQuery(db, "SELECT
t.tree, -- tree identified code
(t.carbon_ag * 2)*(t.tpa_unadj) live_biomass, -- biomass (lbs) of tree
t.tpa_unadj count, --trees/acre
t.dia, -- DBH in inches
t.ht, --Total live tree height in feet
t.actualht, --The measure height in feet
t.agentcd, --tree damage
t.mortyr, --mortality year
t.plot, t.statuscd, t.invyr, r.common_name, t.spcd, c.fortypcd,
c.fldtypcd, rft.meaning, c.stdage, c.fldage, t.totage, t.bhage,
c.dstrbcd1, c.dstrbyr1, p.ecosubcd, p.lat, p.lon
FROM
cond c,
plot p,
tree t, -- tree table must be included for tree-level estimates
ref_species r,
ref_forest_type rft
WHERE p.cn = c.plt_cn
AND t.plt_cn = c.plt_cn
AND t.condid = c.condid
AND c.cond_status_cd = 1 --2 means non-forest
--AND t.statuscd = 1 --1 means live trees, 2 means dead trees
AND t.spcd = r.spcd
AND t.dia >= 1.0 -- additional where_clause from ref_pop_attribute table
AND rft.value = c.fldtypcd
--All Sierra Eco SubCodes
--South Sierra
AND (P.ECOSUBCD = 'M261Ep' OR P.ECOSUBCD = 'M261Eq' OR P.ECOSUBCD = 'M261Eu' OR P.ECOSUBCD = 'M261Er' OR P.ECOSUBCD = 'M261Eo' OR P.ECOSUBCD = 'M261Es' OR
--NOrth Sierra
P.ECOSUBCD = 'M261Ea' OR P.ECOSUBCD = 'M261Eb' OR P.ECOSUBCD = 'M261Ec' OR P.ECOSUBCD = 'M261Ed' OR P.ECOSUBCD = 'M261Ef' OR P.ECOSUBCD = 'M261Eg' OR P.ECOSUBCD = 'M261Eh' OR P.ECOSUBCD = 'M261Ej' OR P.ECOSUBCD = 'M261Ek' OR P.ECOSUBCD = 'M261El' OR P.ECOSUBCD = 'M261Em' OR P.ECOSUBCD = 'M261Et')
--Combined Sierra and SoCal Stand Age
--AND (P.ECOSUBCD = 'M261Ep' OR P.ECOSUBCD = 'M261Eq' OR P.ECOSUBCD = 'M261Eu' OR P.ECOSUBCD = 'M261Er' OR P.ECOSUBCD = 'M261Eo' OR P.ECOSUBCD = 'M261Es' OR P.ECOSUBCD = 'M262Bd' OR P.ECOSUBCD = 'M262Be' OR P.ECOSUBCD = 'M262Bg' OR P.ECOSUBCD = 'M262Bh' OR P.ECOSUBCD = 'M262Bf' OR P.ECOSUBCD = 'M262Bo' OR P.ECOSUBCD = 'M262Bi' OR P.ECOSUBCD = 'M262Bm' OR P.ECOSUBCD = 'M262Bl' OR P.ECOSUBCD = 'M262Bc' OR P.ECOSUBCD = 'M262Bp' OR P.ECOSUBCD = 'M262Bb' OR P.ECOSUBCD = 'M262Ba')
AND (c.dstrbcd1 = 0 OR c.dstrbcd1 = 10 OR c.dstrbcd1 = 11 OR c.dstrbcd1 = 12 OR c.dstrbcd1 = 54 OR c.dstrbcd1 = 70) -- No Fires OR c.dstrbcd1 = 30 OR c.dstrbcd1 = 31 OR c.dstrbcd1 = 32)
")
#DSTRBCD1 == 30, 31, 32 reference fires
all <- dbFetch(q1, n = -1)
# dbDisconnect(db)
summary(all)
#Convert per acre to per hectare
all$count <- all$count * 2.47105 # Convert to per hectare
all$DIA <- all$DIA * (2.54) #Convert to centimeters
all$basal_area <- (((all$DIA / 2)^2) * pi)*(1/10000) * all$count
live <- all %>% filter(STATUSCD == 1) %>% group_by(INVYR, PLOT) %>% summarize(count.live = n(), tpa.live = sum(count), basal_area.live = sum(basal_area), STDAGE = median(STDAGE), ECOSUBCD = first(ECOSUBCD), latitude = median(LAT), longitude = median(LON))
live
#There is a slightly different result when using INVYR instead of MORTYR to calculate annual mortality
dead <- all %>% filter(STATUSCD == 2 & MORTYR %in% c("2013", "2014", "2015", "2016", "2017", "2018", "2019")) %>% group_by(PLOT, INVYR) %>% summarize(count.dead = n(), tpa.dead = sum(count), basal_area.dead = sum(basal_area))
# dead <- dead %>% mutate(INVYR = MORTYR) & MORTYR %in% c("2013", "2014", "2015", "2016", "2017", "2018", "2019")
dead
join <- left_join(live, dead, by = c('PLOT', 'INVYR'))
#Replace the NAs with 0s
join <- join %>% dplyr::mutate(basal_area.dead = replace(basal_area.dead, is.na(basal_area.dead), 0),
count.dead = replace(count.dead, is.na(count.dead), 0),
tpa.dead = replace(tpa.dead, is.na(tpa.dead), 0))
summary(join)
#Add the total basal area calculations
join$count.all <- join$count.live + join$count.dead
join$tpa.all <- join$tpa.live + join$tpa.dead
join$basal_area.all <- join$basal_area.live + join$basal_area.dead
summary(join)
spat.join <- join %>% filter(INVYR %in% c(2015,2016,2017,2018,2019) & (!is.na(STDAGE) & STDAGE != 9999) & STDAGE > 0)
# summary(spat.join)
#Make the FIA data into spatila points
# coordinates(spat.join) <- ~ longitude + latitude
spat.join <- st_as_sf(spat.join, coords=c("longitude", "latitude"), crs="EPSG:4326")
# spat.join <- spat.join %>% st_as_sf()
# crs(spat.join) <-
# plot(spat.join)
#Create the ecoregion summaries
ecosubcd.summary <- join %>% filter(INVYR %in% c(2015,2016,2017,2018,2019) & (!is.na(STDAGE) & STDAGE != 9999) & STDAGE > 0) %>% group_by(ECOSUBCD) %>% summarize(BAA.all = mean(basal_area.all), BAA.dead = mean(basal_area.dead), stdage.mean = mean(STDAGE), tpa.all = mean(tpa.all), tpa.dead = mean(tpa.dead))
#REname the ECOSUBCD Column
ecos.sum <- ecosubcd.summary %>% rename(MAP_UNIT_S = ECOSUBCD)
ecos.sum
usfs.sierra
ecosubcd.join <- left_join(usfs.sierra, ecos.sum, by = 'MAP_UNIT_S')
ecosubcd.join
# If necessary: install/update packages
# install.packages('rlang',repo='https://cloud.r-project.org/')
library("raster")
wrcc.dir <- 'D://Large_Files//WRCC//SPI48'
spi48.2015 <- raster(file.path(wrcc.dir, 'spi48_2015_9_PRISM.tif'))
c <- crs("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs")
#Read in a raster of general WGS 84 crs in PROJ4 code format
wg <- crs("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0")
sierra.ext <- as(extent(south.sierra), 'SpatialPolygons')
sierra.ext <- as(extent(south.sierra %>% union()), 'SpatialPolygons')
sierra.ext <- as(extent(south.sierra %>% union()), 'sf')
sierra.ext <- st_bbox(usfs.sierra %>% st_union())
crs(sierra.ext) <- c
wrcc.dir <- 'D://Large_Files//WRCC//SPI48'
spi48.2015 <- raster(file.path(wrcc.dir, 'spi48_2015_9_PRISM.tif'))
c <- crs("+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +datum=NAD83 +units=m +no_defs")
#Read in a raster of general WGS 84 crs in PROJ4 code format
wg <- crs("+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs+ towgs84=0,0,0")
sierra.ext <- st_bbox(usfs.sierra %>% st_union())
# crs(sierra.ext) <- c
spi48.2015.crop <- crop(spi48.2015, sierra.ext)
library('terra')
#Crop the SPI48 data
spi48.2015.crop <- terra::crop(spi48.2015, sierra.ext)
#Crop the SPI48 data
spi48.2015.crop <- raster::crop(spi48.2015, extent(sierra.ext))
# crs(sierra.ext) <- c
sierra.ext
extent(matrix(sierra.ext), nrow = 2)
extent(matrix(sierra.ext))
# crs(sierra.ext) <- c
sierra.ext$bbox
# crs(sierra.ext) <- c
(usfs.sierra %>% st_union)$bbox
# crs(sierra.ext) <- c
(usfs.sierra %>% st_union() %>% st_bbox())$bbox
# crs(sierra.ext) <- c
(usfs.sierra %>% st_union())$bbox
# crs(sierra.ext) <- c
sierra.ext
extent(vector(sierra.ext))
terra::ext(sierra.ext)
terra::ext(vector(sierra.ext))
spi48.2015.m <- spi48.2015 == -9999
spi48.2015.mask <- mask(spi48.2015, mask = spi48.2015.m, maskvalue = 1)
spi48.2015.mask <- raster::mask(spi48.2015, mask = spi48.2015.m, maskvalue = 1)
plot(spat.join)
spi48.2015.mask$crs
spi48.2015.mask@crs
spat.join@crs
spi48.2015.mask
spat.join
#Make the raster into centroids
raster::extract(x = spi48.mask, y = spat.join, fun = mean, buffer = 0.02, metho = 'simple')
#Make the raster into centroids
raster::extract(x = spi48.2015.mask, y = spat.join, fun = mean, buffer = 0.02, metho = 'simple')
#Make the raster into centroids
raster::extract(x = spi48.2015.mask, y = spat.join, fun = mean, buffer = 0.02, metho = 'simple', df = TRUE)
# spi48.2015.mask@crs
# spi48.2015.mask
#Extract the raster data
#How to I add it back to the spat join data?
SpatialPointsDataFrame(spat.join)
# spi48.2015.mask@crs
# spi48.2015.mask
#Extract the raster data
#How to I add it back to the spat join data?
SpatialPointsDataFrame(coordinates(spat.join))
spat.join
extract.spi48 <- raster::extract(x = spi48.2015.mask, y = spat.join, fun = mean, buffer = 0.02, metho = 'simple', df = TRUE)
extract.spi48$plotID <- spat.join$PLOT
extract.spi48
plots <- merge(spat.join, extract.spi48, by.x = 'PLOT', by.y = 'plotID')
plots
